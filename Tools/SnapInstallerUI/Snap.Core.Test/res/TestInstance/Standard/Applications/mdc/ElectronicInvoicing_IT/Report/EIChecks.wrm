//==============================================================================
// Woorm code behind
//==============================================================================

Release 7 Rect (72,1922,1048,3838) ReportTemplate "Report.erp.core.Ocean.wrmt" 

Properties
	Begin
		Title "Electronic Invoice Checks" 
		Subject "" 
		Author "" 
		ReportProducer "" 
		Comments "" 
		DefaultSecurityRoles "Sales,cSales Employee" 
	End

PageInfo (2,9,2970,2100,100,1,1,True ) 

PageLayout "default" 
	Begin
		Field (6,31,22,1052) Alias 17  /* w_OurRefCompanyName */ 
			Begin
				Style "CompanyName" 

			End

		Field (6,32,22,1053) Alias 16  /* w_AppDate */ FormatStyle "Date" 
			Begin
				Style "Date" 

			End

		Text (15,32,45,1053) "Electronic Invoice Checks" 

			Begin
				Style "ListTitle" 
			End

		Text (63,541,83,655) "From Date" 

			Begin
			End

		Field (63,655,83,769) Alias 7  /* w_AskFromDate */ FormatStyle "Date" 
			Begin
				Align 67686 ;

			End

		Text (63,777,83,891) "From Customer" 

			Begin
			End

		Field (63,891,83,1005) Alias 2  /* w_TitleCodeFrom */ 
			Begin
				Align 67684 ;

			End

		Text (65,372,84,530) "Selections made:" 

			Begin
				Style "AccessoryDescription" 
			End

		Text (82,541,102,655) "To Date" 

			Begin
				Borders (0,1,1,1) ;
			End

		Field (82,655,102,769) Alias 8  /* w_AskToDate */ FormatStyle "Date" 
			Begin
				Align 67686 ;

			End

		Text (82,777,102,891) "To Customer" 

			Begin
			End

		Field (82,891,102,1005) Alias 3  /* w_TitleCodeTo */ 
			Begin
				Align 67684 ;

			End

		Text (106,541,126,655) "From Doc. No" 

			Begin
				Borders (0,1,1,1) ;
			End

		Field (106,655,126,769) Alias 5  /* w_TitleDocNoFrom */ 
			Begin
				Align 67684 ;

			End

		Text (106,777,126,891) "Document Status" 

			Begin
			End

		Field (106,891,126,1005) Alias 37  /* w_TitleEIStatus */ 
			Begin
				Align 67684 ;

			End

		Text (125,541,145,655) "To Doc. No" 

			Begin
			End

		Field (125,655,145,769) Alias 6  /* w_TitleDocNoTo */ 
			Begin
				Align 67684 ;

			End

		Table (27,8) "" Alias 78  /* Table78 */ Origin (33,154) Heights (8,44,18,17) 
		HideTitle
		Title FontStyle "Text" ;
			Begin
				"Document Type" Alias 26  /* w_InvoiceType */ Width 150 FormatStyle "Enum" Break ;
				"" Alias 9  /* w_IdentifierDocument */ Width 0 FormatStyle "Long" Hidden Width 100 ;
				"Document No" Alias 30  /* w_DocNo */ Width 70 ;
				"Document Date" Alias 10  /* w_InvoiceDate */ Width 75 FormatStyle "Date" ;
				"Document Status" Alias 13  /* w_EIStatus */ Width 200 FormatStyle "Enum" ;
				"Customer" Alias 11  /* w_CustomerSupplier */ Width 80 ;
				"Customer Name" Alias 15  /* w_CompanyName */ Width 320 Break ;
				"EI Office Code" Alias 27  /* w_IPACode */ Width 80 ;
			End


		Field (738,5,757,1075) Alias 18  /* w_NrPage */ FormatStyle "Integer" 
			Begin
				Style "PageNumber" 

			End

	End
Links
	Begin
		LinkForm "MDC.MDC.Documents.Invoice" 
			On w_DocNo 
			When
				 ( w_InvoiceType = {52:2} )
			Begin
				Long SaleDocId =  w_IdentifierDocument ;
			End

		LinkForm "MDC.MDC.Documents.AccInvoice" 
			On w_DocNo 
			When
				 ( w_InvoiceType = {52:3} )
			Begin
				Long SaleDocId =  w_IdentifierDocument ;
			End

		LinkForm "MDC.MDC.Documents.InvoiceForAdvance" 
			On w_DocNo 
			When
				 ( w_InvoiceType = {52:11} )
			Begin
				Long SaleDocId =  w_IdentifierDocument ;
			End

		LinkForm "MDC.MDC.Documents.CreditNote" 
			On w_DocNo 
			When
				 ( w_InvoiceType = {52:4} )
			Begin
				Long SaleDocId =  w_IdentifierDocument ;
			End

		LinkForm "MDC.MDC.Documents.DebitNote" 
			On w_DocNo 
			When
				 ( w_InvoiceType = {52:17} )
			Begin
				Long SaleDocId =  w_IdentifierDocument ;
			End

		LinkForm "ERP.CustomersSuppliers.Documents.Customers" 
			On w_CustomerSupplier 
			Begin
				Enum[49]  /* CustSupp Type */ CustSuppType =  w_Custsupptype ;
				String CustSupp =  w_CustomerSupplier ;
			End

	End


Report 
	Begin NoName
		Tables
			Tabella_1 [27] Alias 78 ;
		End

		Variables
			Bool         w_AskAllCustomers [1] Alias 1  Input Init = FALSE  ;
			String       w_AskCustomerFrom [8] Alias 2  Input ;
			String       w_AskCustomerTo [8] Alias 3  Input ;
			Bool         w_AskAllDocNo [1] Alias 4  Input Init = FALSE  ;
			String       w_AskDocNoFrom [8] Alias 5  Input ;
			String       w_AskDocNoTo [8] Alias 6  Input ;
			Date         w_AskFromDate [19] Alias 7  Input Init = DATE ( 1 , Month ( AppDate ( ) ) , Year ( AppDate ( ) ) )  ;
			Date         w_AskToDate [19] Alias 8  Input Init = AppDate ( )  ;
			Long         w_IdentifierDocument [8] Alias 9  Column ;
			Date         w_InvoiceDate [19] Alias 10  Column ;
			String       w_CustomerSupplier [8] Alias 11  Column ;
			Enum[490]     /* Electronic Ivoicing Status */ w_EIStatus [10] Alias 13  Column ;
			Enum[49]      /* CustSupp Type */ w_Custsupptype [10] Alias 14  Hidden Init = { 49 : 0 }  ;
			String       w_CompanyName [40,1] Alias 15  Column ;
			Date         w_AppDate [8] Alias 16 Init = AppDate ( )  ;
			String       w_OurRefCompanyName [64] Alias 17 ;
			Integer      w_NrPage [6] = w_NrPage + 1  Alias 18 Init = 1  ;
			Bool         w_EmptyToDate [1] Alias 19  Hidden ;
			Bool         w_AskSelectAll [22] Alias 20  Hidden  Input Init = TRUE  ;
			Bool         w_AskPublAuth [22] Alias 21  Hidden  Input Init = FALSE  ;
			Bool         w_AskNoPublAuth [22] Alias 22  Hidden  Input Init = FALSE  ;
			String       w_TitleEIStatus [20] Alias 37 Init = Localize ( "ALL" )  ;
			Enum[52]      /* Document Type */ w_InvoiceType [20,1] Alias 26  Column ;
			String       w_IPACode [9] Alias 27  Column ;
			String       w_DocNo [10] Alias 30  Column ;
			Bool         w_AskDialog [1] Alias 34  Hidden Init = TRUE  ;
			String       w_IPACodeBranches [9] Alias 35  Hidden ;
			String       w_SendDocumentTo [20] Alias 36  Hidden ;
			Enum[490]     /* Electronic Ivoicing Status */ w_AskEIStatus [15,1] Alias 38  Hidden  Input Init = { 490 : 0 }  ;
			Bool         w_AskAllEIStatus [3] Alias 39  Hidden  Input Init = TRUE  ;
			String       w_IPACodeCustSupp [9] Alias 40  Hidden ;
			Bool         w_DisposeOk [1] Alias 41  Hidden ;
		End

		Rules
			From MA_SaleDoc , MA_CustSupp , MA_CustSuppCustomerOptions
			Select  Not NULL 
				MA_SaleDoc.SaleDocId		Into w_IdentifierDocument ,
				MA_SaleDoc.DocNo			Into w_DocNo ,
				MA_SaleDoc.DocumentDate		Into w_InvoiceDate ,
				MA_SaleDoc.CustSupp			Into w_CustomerSupplier ,
				MA_SaleDoc.CustSuppType		Into w_Custsupptype ,
				MA_SaleDoc.EIStatus			Into w_EIStatus ,
				MA_SaleDoc.DocumentType		Into w_InvoiceType ,
				MA_SaleDoc.SendDocumentsTo	Into w_SendDocumentTo ,
				MA_CustSupp.CompanyName		Into w_CompanyName ,
				MA_CustSupp.IPACode			Into w_IPACodeCustSupp
			Where ( MA_SaleDoc.DocumentType = { 52 : 2 } OR MA_SaleDoc.DocumentType = { 52 : 3 } OR MA_SaleDoc.DocumentType = { 52 : 11 } OR MA_SaleDoc.DocumentType = { 52 : 4 } OR MA_SaleDoc.DocumentType = { 52 : 17 } ) AND 
				MA_SaleDoc.CustSuppType = w_Custsupptype AND 
				( w_AskAllCustomers = TRUE OR ( MA_SaleDoc.CustSupp BETWEEN w_AskCustomerFrom and w_AskCustomerTo ) ) AND 
				( w_AskAllDocNo = TRUE OR ( MA_SaleDoc.DocNo BETWEEN w_AskDocNoFrom and w_AskDocNoTo ) ) AND 
				( w_AskAllEIStatus = TRUE OR MA_SaleDoc.EIStatus = w_AskEIStatus ) AND 
				MA_SaleDoc.DocumentDate >= w_AskFromDate AND 
				( w_EmptyToDate = TRUE OR MA_SaleDoc.DocumentDate <= w_AskToDate ) AND 
				MA_CustSupp.ElectronicInvoicing = TRUE AND 
				MA_CustSupp.CustSupp = MA_SaleDoc.CustSupp AND 
				MA_CustSupp.CustSuppType = MA_SaleDoc.CustSuppType AND
				MA_CustSuppCustomerOptions.Customer = MA_SaleDoc.CustSupp AND
				( w_AskSelectAll == TRUE OR (w_AskPublAuth == TRUE And MA_CustSuppCustomerOptions.PublicAuthority = TRUE) OR (w_AskNoPublAuth == TRUE And MA_CustSuppCustomerOptions.PublicAuthority = FALSE)) 
			Order By  MA_SaleDoc.DocumentDate, MA_SaleDoc.DocNo ;

			From MA_Company 
			Select 
				CompanyName          Into w_OurRefCompanyName ;			
		End


		Events
			FormFeed : Do
				Before 
					Begin
						Display w_NrPage ;
					End
				After 
					Begin
						Eval w_NrPage ;
					End

			Report : Do
				Always 
					Begin
						w_IPACode = w_IPACodeCustSupp;
						If ( w_SendDocumentTo != "" ) 
						Then 
							Begin	
								w_DisposeOk = Framework.TbWoormViewer.TbWoormViewer.QueryOpen ( "BranchesIPACode" )  ;
								w_DisposeOk = Framework.TbWoormViewer.TbWoormViewer.QueryRead ( "BranchesIPACode" )  ;
								w_DisposeOk = Framework.TbWoormViewer.TbWoormViewer.QueryClose( "BranchesIPACode" )  ;
								if (w_IPACodeBranches != "")
									Then w_IPACode = w_IPACodeBranches ;
							End;			
						DisplayTableRow;
						NextLine;			
					End
				Before 
					Begin
						
						If ( NOT w_AskAllEIStatus ) 
							Then 
								Begin
									w_TitleEIStatus = Format ( w_AskEIStatus )  ;
								End ;
					End
				After 
					Begin
						Display w_NrPage ;
					End
				Finalize 
					Begin
					End
		End

	Queries
		Begin
			Query  BranchesIPACode
			Begin
				{
				SELECT 
				IPACode { COL w_IPACodeBranches }
				FROM MA_CustSuppBranches
				WHERE	
						Branch			= {IN w_SendDocumentTo} AND
						CustSupp		= {IN w_CustomerSupplier} AND
						CustSuppType	= {IN w_Custsupptype }
				}
			End
		End


	Dialogs
		Begin
			Dialog ElectronicInvoicing  "Selections" 
				Begin
					When w_AskDialog 
					Controls
						Begin
							Begin  "Customer Type"  
								w_AskSelectAll Style = 1 Prompt = "All" ;
								w_AskPublAuth Style = 1 Prompt = "Public Authorities"  ;
								w_AskNoPublAuth Style = 1 Prompt = "B2B" ;
							End
							Begin  "Customer"  
								w_AskCustomerFrom Prompt = "From" LowerLimit HotLink MDC.ElectronicInvoicing_IT.Dbl.CustSuppByElectronicInvoicing ( 0 , 2 , 1 ) ;
								w_AskCustomerTo Prompt = "To" UpperLimit HotLink MDC.ElectronicInvoicing_IT.Dbl.CustSuppByElectronicInvoicing ( 0 , 2 , 1 ) ;
							End
							Begin  "Document Date"  
								w_AskFromDate Prompt = "From" ;
								w_AskToDate Prompt = "To" ;
							End
							Begin  "Doc. No"  
								w_AskDocNoFrom Prompt = "From" LowerLimit HotLink MDC.ElectronicInvoicing_IT.Dbl.SaleDocForElectronicInvoicing ( ) ;
								w_AskDocNoTo Prompt = "To" UpperLimit HotLink MDC.ElectronicInvoicing_IT.Dbl.SaleDocForElectronicInvoicing ( ) ;
							End
							Begin  "Document Status"  
								w_AskAllEIStatus Prompt = "All" ;
								w_AskEIStatus Prompt = "" ReadOnly w_AskAllEIStatus  ;
							End
						End
				End
		End
End

