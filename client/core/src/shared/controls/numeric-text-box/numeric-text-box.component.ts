import { TbComponentService } from './../../../core/services/tbcomponent.service';
import { LayoutService } from './../../../core/services/layout.service';
import { EventDataService } from './../../../core/services/eventdata.service';
import { FormattersService } from './../../../core/services/formatters.service';

import { Component, Input, OnChanges, AfterViewInit, ChangeDetectorRef } from '@angular/core';

import { ControlComponent } from './../control.component';

import { align } from '@progress/kendo-drawing/main';

@Component({
  selector: 'tb-numeric-text-box',
  templateUrl: './numeric-text-box.component.html',
  styleUrls: ['./numeric-text-box.component.scss']
})
export class NumericTextBoxComponent extends ControlComponent implements OnChanges, AfterViewInit {
  @Input() forCmpID: string;
  @Input() disabled: boolean;

  // automatically generated by tbjson.exe, representing properties customization for numeric controls in tbjson files
  @Input() decimals = 0;
  @Input() minValue: number = null;
  @Input() maxValue: number = null;

  @Input() public hotLink: any = undefined;

  formatterProps: any;
  controlDecimals = 0;
  errorMessage: string;
  public constraint: RegExp = new RegExp('\\d');
  showError = '';
  public selectedValue: number;

  // public formatOptionsCurrency: any = {
  //   style: 'currency',
  //   currency: 'EUR'/*,
  //   currencyDisplay: 'name'*/
  // };
  // public formatOptionsInteger: any = {
  //   style: 'decimal'
  // };

  // public formatOptionsDouble = 'F';

  // public formatOptionsPercent: any = {
  //   style: 'percent'
  // };

  constructor(
    public eventData: EventDataService,
    private formattersService: FormattersService,
    layoutService: LayoutService,
    tbComponentService: TbComponentService,
    changeDetectorRef: ChangeDetectorRef
  ) {
    super(layoutService, tbComponentService, changeDetectorRef);

    // DEBUG
    this.formatter = "Double";
  }

  ngOnInit() {
    if (this.formatter)
      this.formatterProps = this.formattersService.getFormatter(this.formatter);
  }

  getDecimals() {
    if (this.decimals > 0) {
      this.controlDecimals = this.decimals;
    } else {
      switch (this.formatter) {
        case 'FiscalYear':
        case 'Integer':
          this.controlDecimals = 0;
        default:
          if (this.formatterProps && this.formatterProps.refDecNumber) {
            this.controlDecimals = +this.formatterProps.refDecNumber;
          }
      }
    }
    return this.controlDecimals;
  }

  getMinValue(): any {
    switch (this.formatter) {
      case 'PositiveMoney':
      case 'PositiveRoundedMoney':
      case 'Fixing':
      case 'MoneyWithoutDecimal':
        return this.minValue && this.minValue > 0 ? this.minValue : 0;

      default:
        return this.minValue;
    }
  }

  getFormatOptions(): any {

    if (this.decimals > 0) {
      return 'n' + this.getDecimals().toString();
    } else {
      switch (this.formatter) {
        case 'FiscalYear':
        case 'Integer':
          return '#';
        default:
          return 'n' + this.getDecimals().toString();
      }
    }
  }

  public onChange(val: any) {
    this.onUpdateNgModel(val);
  }

  onUpdateNgModel(newValue: number): void {
    if (!this.modelValid()) {
      this.model = { enable: 'true', value: '' };
    }
    this.selectedValue = newValue;
    this.model.value = newValue;
  }

  ngAfterViewInit(): void {
    if (this.modelValid()) {
      this.onUpdateNgModel(this.model.value);
    }
  }

  ngOnChanges(): void {
    if (this.modelValid()) {
      this.onUpdateNgModel(this.model.value);
    }
  }

  modelValid() {
    return this.model !== undefined && this.model !== null;
  }


  onBlur(): any {
    switch (this.formatter) {
      case 'Integer':
      case 'Long':
      case 'Money':
      case 'Percent':
        this.constraint = new RegExp('\\d');
        break;
      case 'Double':
        this.constraint = new RegExp('[-+]?[0-9]*\.?[0-9]+');
        break;

      default: break;
    }

    if (!this.constraint.test(this.model.value)) {
      this.errorMessage = 'Input not in correct form';
      this.showError = 'inputError';
    }
    else {
      this.errorMessage = '';
      this.showError = '';
    }
    this.eventData.change.emit(this.cmpId);
    this.blur.emit(this);
  }
}
